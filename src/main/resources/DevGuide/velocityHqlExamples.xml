<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>DevGuide</web>
  <name>velocityHqlExamples</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>DevGuide.Scripting</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1191919404000</creationDate>
  <date>1360950275000</date>
  <contentUpdateDate>1360950275000</contentUpdateDate>
  <version>1.1</version>
  <title>Velocity HQL Examples</title>
  <template/>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>false</hidden>
  <object>
    <class>
      <name>XWiki.TagClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <tags>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>tags</name>
        <number>1</number>
        <prettyName>Tags</prettyName>
        <relationalStorage>1</relationalStorage>
        <separator>|</separator>
        <separators>|,</separators>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <values/>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </tags>
    </class>
    <name>DevGuide.velocityHqlExamples</name>
    <number>0</number>
    <className>XWiki.TagClass</className>
    <guid>959d6b3a-797d-48a8-9349-615ba2aa356b</guid>
    <property>
      <tags/>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>DevGuide.velocityHqlExamples</name>
    <number>0</number>
    <className>XWiki.XWikiRights</className>
    <guid>28890584-3500-4cb0-a368-fbae85c3cda9</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>xwiki:XWiki.XWikiAdminGroup</groups>
    </property>
    <property>
      <levels>edit</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>DevGuide.velocityHqlExamples</name>
    <number>1</number>
    <className>XWiki.XWikiRights</className>
    <guid>d5781834-80ed-42d9-bb01-afeff7bef45e</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>xwiki:XWiki.XWikiCommittersGroup</groups>
    </property>
    <property>
      <levels>edit</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>DevGuide.velocityHqlExamples</name>
    <number>2</number>
    <className>XWiki.XWikiRights</className>
    <guid>74f6bc76-d61b-4816-a115-82dc057df8f3</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>xwiki:XWiki.XWikiPowerUsers</groups>
    </property>
    <property>
      <levels>edit</levels>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <name>DevGuide.velocityHqlExamples</name>
    <number>3</number>
    <className>XWiki.XWikiRights</className>
    <guid>9549dcc9-db7c-41ec-bdc9-1d6e3bab8624</guid>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>xwiki:XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>edit</levels>
    </property>
  </object>
  <content>{{box cssClass="floatinginfobox" title="**Contents**"}}
{{toc start="2" depth="4"/}}
{{/box}}

= HQL Query Examples in Velocity =

XWiki allows user to access documents and objects with [[HQL&gt;&gt;http://docs.jboss.org/hibernate/stable/core/reference/en/html/queryhql.html]] queries in [[Velocity&gt;&gt;http://jakarta.apache.org/velocity/docs/user-guide.html]] scripts.

== Public API (##searchDocuments##) ==

{{velocity}}
{{html}}
#info("With this API the query consist in the WHERE condition of a full HQL query. Any user with edit rights can write a script using this API. Any user with view rights can view the result of such a query.")
{{/html}}
{{/velocity}}

General example showing how to display the first 5 results of a given query:

{{code language="none"}}
#set($hql = "&lt;query here&gt;")
#set($results = $xwiki.searchDocuments($hql, 5, 0))
#foreach ($item in $results)
 * $item
#end
{{/code}}

The examples below will show you various HQL queries that you can write.

=== Simple Query ===

Displays all documents who have been created by the user ##XWiki.JohnDoe##:

{{code language="none"}}
#set($hql = "where doc.creator='XWiki.JohnDoe'")
{{/code}}

=== Ordered Query ===

Displays all documents who have been created by the user ##XWiki.JohnDoe## and sorted by document's last modification date, in ascending order:

{{code language="none"}}
#set($hql = "where doc.creator='XWiki.VincentMassol' order by doc.date asc")
{{/code}}

=== Advanced Query (date &amp; time) ===

{{velocity}}
{{html wiki="true"}}
#info("Since there is no [[standard way to calculate dates interval in HQL&gt;&gt;http://opensource.atlassian.com/projects/hibernate/browse/HHH-2434]] those queries are a bit unnatural.")
{{/html}}
{{/velocity}}

{{code language="none"}}
#set($hql = "where year(doc.date) = year(current_date()) and month(doc.date) = month(current_date()) and day(doc.date) = day(current_date()) and hour(doc.date) &gt; (hour(current_time()) - 1)  order by doc.date desc")
{{/code}}

Other examples:

* Listing all documents modified during the current day: {{code language="none"}}where year(doc.date) = year(current_date()) and month(doc.date) = month(current_date()) and day(doc.date) &gt; (day(current_date()) - 1) order by doc.date desc{{/code}}
* Listing all documents modified during the current week: {{code language="none"}}where year(doc.date) = year(current_date()) and month(doc.date) = month(current_date()) and day(doc.date) &gt; (day(current_date()) - 7) order by doc.date desc{{/code}}
* Listing all documents modified during the current month: {{code language="none"}}where year(doc.date) = year(current_date()) and month(doc.date) &gt; (month(current_date()) - 1) order by doc.date desc{{/code}}


== Privileged API (##search##) ==

{{velocity}}
{{html wiki="true"}}
#warning("Calls to te privileged API are only executed when the calling page has been saved by a user with **Programming Rights**. The reason is that search can be used to send dangerous HQL command like update, delete, etc.")
{{/html}}
{{/velocity}}

General example showing how to display the first 5 results of a given query:

{{code language="none"}}
#set($hql = "&lt;query here&gt;")
#set($results = $xwiki.search($hql, 5, 0))
#foreach ($item in $results)
 * $item
#end
{{/code}}

The examples below will show you various HQL queries that you can write.

=== Simple Query ===

{{code language="none"}}
#set($hql = "select doc.name from XWikiDocument doc")
{{/code}}

=== Count Query ===

{{code language="none"}}
#set($results = $xwiki.search("select count(doc) from XWikiDocument doc"))
## Since $xwiki.search is returning a list, we get its first element
Count : $results.get(0)
{{/code}}

=== Simple Query with multiple fields ===

{{code language="none"}}
#set($results = $xwiki.search("select doc.name, doc.date from XWikiDocument doc", 5, 0))
#foreach ($row in $results)
  #foreach ($col in $row)
    #if ($velocityCount == 1)
      #set($docName = $col)
    #elseif ($velocityCount == 2)
      #set($docDate = $col)
    #end
  #end
  $docName : $docDate &lt;br/&gt;
#end
{{/code}}

=== Getting objects of a specific class ===

{{code language="none"}}
#set($hql = "select obj.name from BaseObject obj where obj.className='XWiki.XWikiUsers'")
{{/code}}

=== Getting objects' properties ===

{{code language="none"}}
#set($hql = "select obj.name, prop.value from BaseObject obj, StringProperty prop where obj.className='XWiki.XWikiUsers' and prop.id.id=obj.id and prop.name='first_name'")
{{/code}}

=== Getting documents where objects' properties equals some value ===

{{code language="none"}}
#set($hql = "select doc.fullName from XWikiDocument doc, BaseObject obj, StringProperty prop where doc.fullName=obj.name and obj.className='XWiki.XWikiUsers' and prop.id.id=obj.id and prop.name='first_name' and prop.value='Jean-Vincent'")
{{/code}}

{{code language="none"}}
#set($hql = ", BaseObject as obj, StringProperty as firstName, StringProperty as lastName where doc.fullName = obj.name and obj.className='XWiki.XWikiUsers' and obj.id=firstName.id.id and firstName.id.name='first_name' and obj.id=lastName.id.id and lastName.id.name='last_name' and firstName.value like 'A%' and lastName.value like 'B%' order by doc.fullName asc")
{{/code}}

=== List users currently editing pages ===

{{code language="none"}}
#set($hql = "select distinct lock.userName from XWikiLock lock")
{{/code}}

=== List attachments of a page ===

{{code language="none"}}
#set($hql = "select att.filename from XWikiAttachment att, XWikiDocument doc where doc.fullName='Main.WebHome' and att.docId=doc.id")
{{/code}}

=== Statistics ===

* [[Most Viewed Articles Snippet&gt;&gt;extensions:Extension.Most Viewed Articles]]
* [[Most Active Contributors In Group Snippet&gt;&gt;extensions:Extension.Most Active Contributors In Group]]
* [[Number Of Active Users Per Day And Per Week Snippet&gt;&gt;extensions:Extension.Number Of Active Users Per Day And Per Week]]
* [[Number Of Edited Articles Per Day And Per Week Snippet&gt;&gt;extensions:Extension.Number Of Edited Articles Per Day And Per Week]]
* [[Number Of Created Articles Per Day And Per Week Snippet&gt;&gt;extensions:Extension.Number Of Created Articles Per Day And Per Week]]
* [[Number Of Deleted Articles Per Day And Per Week Snippet&gt;&gt;extensions:Extension.Number Of Deleted Articles Per Day And Per Week]]

== Non-exhaustive list of queryable Object Fields ==

The full list of available fields can be found in the Hibernate mapping files (*.hbm.xml), which can be found inside WEB-INF/lib/xwiki-core-x.y.jar (where x.y is the XWiki version).

=== XWikiDocument ===

* **XWikiDocument.fullName** : full name, including space and page name. Example value: ##Main.WebHome##
* XWikiDocument.author : last editor. Example value: ##XWiki.Admin##
* XWikiDocument.creator : first editor. Example value: ##XWiki.Admin##

=== BaseObject ===

* **BaseObject.id** : arbitrary unique id of the object. Example value: ##123456789##
* BaseObject.className : class. Example value: ##XWiki.XWikiUsers##

=== *Property (StringProperty, IntegerProperty, etc) ===

* **Property.id.id** : unique id of the object the property belongs to. Example value: ##123456789##
* Property.name : name of the property. Example value: ##first_name##
* Property.value : value. Example value: ##John##</content>
</xwikidoc>
